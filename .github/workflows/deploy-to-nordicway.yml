# .github/workflows/deploy-to-nordicway.yml
name: Deploy to Nordicway

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      ref:
        required: false
        type: string
        default: ""
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options: [staging, production]
      ref:
        description: 'Branch, tag, or SHA to deploy (empty = default branch)'
        required: false
        type: string

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    concurrency:
      group: nordicway-${{ inputs.environment }}
      cancel-in-progress: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref != '' && inputs.ref || github.ref }}
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # --- OPTIONAL: build steps for your theme/plugin(s) ---
      # - name: Build Theme
      #   working-directory: wp-content/themes/masterofmagic
      #   run: |
      #     npm ci
      #     npm run build
      #
      # - name: Build Plugin
      #   working-directory: wp-content/plugins/masterofmagic-blocks
      #   run: |
      #     npm ci
      #     npm run build

      - name: Prepare deploy artifact (whole wp-content minus uploads/runtime/dev junk)
        run: |
          mkdir -p artifact/wp-content
          rsync -av wp-content/ artifact/wp-content \
            --exclude='uploads/**' \
            --exclude='upgrade/**' \
            --exclude='cache/**' \
            --exclude='wflogs/**' \
            --exclude='**/node_modules/**' \
            --exclude='**/.git/**' \
            --exclude='**/.github/**' \
            --exclude='**/.gitignore' \
            --exclude='**/package*.json' \
            --exclude='**/composer.*' \
            --exclude='**/webpack.*' \
            --exclude='**/vite.*' \
            --exclude='**/resources/**' \
            --exclude='**/README.md'

      # Ensure destination exists and create a writable per-user tmp dir for appleboy/scp-action
      - name: Preflight (ensure paths exist)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.NORDICWAY_SSH_HOST }}
          username: ${{ secrets.NORDICWAY_SSH_USERNAME }}
          key: ${{ secrets.NORDICWAY_SSH_KEY }}
          port: ${{ secrets.NORDICWAY_SSH_PORT }}
          script_stop: true
          script: |
            set -e
            echo "Ensuring destination path exists…"
            mkdir -p "${{ secrets.NORDICWAY_DEST_PATH }}"
            echo "Creating per-user tmp dir…"
            mkdir -p "/home/${USER}/tmp" || mkdir -p "$HOME/tmp"
            echo "tar version:"
            which tar && tar --version

      - name: Upload wp-content via SCP (SSH key)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.NORDICWAY_SSH_HOST }}
          username: ${{ secrets.NORDICWAY_SSH_USERNAME }}
          key: ${{ secrets.NORDICWAY_SSH_KEY }}
          port: ${{ secrets.NORDICWAY_SSH_PORT }}
          # copy the contents of artifact/wp-content into the remote wp-content
          source: "artifact/wp-content/*"
          target: "${{ secrets.NORDICWAY_DEST_PATH }}/"
          overwrite: true
          # avoid /tmp noexec by forcing a home-based tmp directory
          tar_tmp_path: "/home/${{ secrets.NORDICWAY_SSH_USERNAME }}/tmp"

      - name: Post-deploy sanity check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.NORDICWAY_SSH_HOST }}
          username: ${{ secrets.NORDICWAY_SSH_USERNAME }}
          key: ${{ secrets.NORDICWAY_SSH_KEY }}
          port: ${{ secrets.NORDICWAY_SSH_PORT }}
          script_stop: true
          script: |
            echo "✅ Deployment completed on Nordicway (${{ inputs.environment }})"
            echo "--- wp-content ---"
            ls -lah "${{ secrets.NORDICWAY_DEST_PATH }}" || true
            echo "--- themes ---"
            ls -lah "${{ secrets.NORDICWAY_DEST_PATH }}/themes" || true
            echo "--- plugins ---"
            ls -lah "${{ secrets.NORDICWAY_DEST_PATH }}/plugins" || true
            php -v || true
